<div class="flex w-screen h-max p-5">
  <div class="w-full relative flex-col flex text-center table-container overflow-y-scroll">
    <div class="sticky top-0 flex bg-surface box-border py-5">
      <div *ngIf="kdData.gamemode == 'M'" class="text-xl grid grid-flow-row place-items-center grid-rows-2 w-full">
        <span>Lượt thí sinh:</span>
        @if (lastTurn.name) {
          <strong>{{ lastTurn.name }}</strong>
        }
        @else {
          <strong>Chưa có thí sinh bấm chuông.</strong>
        }
      </div>
      <div class="grid w-full gap-3 place-items-center grid-cols-2">
        <button mat-raised-button (click)="markCorrect()">
          <mat-icon>done</mat-icon>
          Đúng
        </button>
        <button mat-raised-button (click)="markWrong()">
          <mat-icon>clear</mat-icon>
          Sai
        </button>
        <button
          mat-raised-button
          [disabled]="threeSecTimers[1] > 0"
          (click)="start3sTimer()"
        >
          <mat-icon>timer</mat-icon>
          Đếm ngược 3s
        </button>
        <button
          mat-raised-button
          [disabled]="threeSecTimers[1] > 0"
          (click)="playSfx('BLANK_SPC')"
        >
          <mat-icon> music_note </mat-icon>
          Khoảng trắng
        </button>
      </div>
    </div>
    <div class="text-center h-5/6">
      <table
        mat-table
        [dataSource]="
          kdData.gamemode == 'S'
            ? kdData.questions.singleplayer[kdData.currentSingleplayerPlayer]
            : kdData.questions.multiplayer
        "
        class="mat-elevation-z8"
      >
        <ng-container matColumnDef="question">
          <th mat-header-cell *matHeaderCellDef>Câu hỏi</th>
          <td
            mat-cell
            [ngClass]="{
            choose: chosenRow === element,
          }"
            *matCellDef="let element"
          >
            {{ element.question }}
          </td>
        </ng-container>
        <ng-container matColumnDef="answer">
          <th mat-header-cell *matHeaderCellDef>Đáp án</th>
          <td mat-cell *matCellDef="let element">{{ element.answer }}</td>
        </ng-container>
        <ng-container matColumnDef="type">
          <th mat-header-cell *matHeaderCellDef>Loại</th>
          <td mat-cell *matCellDef="let element">{{ element.type }}</td>
        </ng-container>
        <ng-container matColumnDef="subject">
          <th mat-header-cell *matHeaderCellDef>Lĩnh vực</th>
          <td
            [ngClass]="{
            highlight: displayingRow === element,
          }"
            mat-cell
            *matCellDef="let element"
          >
            {{ element.subject }}
          </td>
        </ng-container>
        <tr mat-header-row *matHeaderRowDef="displayedQuestionColumns"></tr>
        <tr
          mat-row
          *matRowDef="let row; columns: displayedQuestionColumns; let i = index"
          class=""
          [ngClass]="{ '': row.ifSong === true }"
          (click)="onClickQuestion(row)"
          (dblclick)="onDoubleClickQuestion(row)"
        ></tr>
      </table>
    </div>
    <div class="text-right bg-surface sticky bottom-0 py-3">
      <button mat-button (click)="clearQuestion()">
        <mat-icon>visibility_off</mat-icon>
        Ẩn câu hỏi
      </button>
      <button mat-button (click)="(undefined)">
        <mat-icon>edit</mat-icon>
        Chỉnh sửa
      </button>
    </div>
  </div>
  <div
    class="w-full flex flex-col items-center text-center table-container"
  >
    <div class="m-5 flex-col text-xl">
      <div class="">
        <mat-form-field appearance="outline">
          <mat-label>Phần thi</mat-label>
          <mat-select
            [(value)]="kdData.gamemode"
            (valueChange)="onGamemodeChange($event)"
          >
            <mat-option *ngFor="let gamemode of ['S', 'M']" [value]="gamemode">
              {{ gamemode == "S" ? "Cá nhân" : "Đối kháng" }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>
      <div class="mt-5">
        <button mat-raised-button (click)="playSfx('KD_START')" class="w-52">
          <mat-icon>music_note</mat-icon>
          Nhạc hiệu
        </button>
      </div>
      <div class="mt-5">
        <button
          mat-raised-button
          color="accent"
          (click)="roundStart(kdData.gamemode == 'S' ? 6 : 12)"
          class="w-52 mt-5"
        >
          <mat-icon>flag</mat-icon>
          Bắt đầu phần thi
        </button>
      </div>
      <div class="mt-5">
        <button
          mat-raised-button
          color="accent"
          (click)="resetTurn()"
          class="w-52 mt-5"
        >
          <mat-icon>replay</mat-icon>
          Reset chuông
        </button>
      </div>
    </div>
    <div class="text-2xl">
      <br />
      Số câu hỏi hiện tại: {{ currentQuestionNo }}/{{ currentMaxQuestionNo }}
    </div>
    <div class="text-2xl mt-5">
      Vị trí thí sinh: <span class="">{{ auth.matchData().matchPos }}</span>
    </div>
    <div class="overflow-x-hidden w-max m-5 text-2xl">
      <table mat-table [dataSource]="auth.matchData().players" class="w-max">
        <ng-container matColumnDef="id">
          <th mat-header-cell *matHeaderCellDef>ID</th>
          <td
            mat-cell
            [ngClass]="{
              choose: chosenPlayer === element
            }"
            *matCellDef="let element"
          >
            {{ element.id }}
          </td>
        </ng-container>
        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef>Tên</th>
          <td mat-cell *matCellDef="let element">{{ element.name }}</td>
        </ng-container>
        <ng-container matColumnDef="score">
          <th mat-header-cell *matHeaderCellDef>Điểm</th>
          <td mat-cell *matCellDef="let element">{{ element.score }}</td>
        </ng-container>
        <ng-container matColumnDef="active">
          <th mat-header-cell *matHeaderCellDef>Đã kết nối?</th>
          <td
            [ngClass]="{
              highlight: kdData.currentSingleplayerPlayer === element.id - 1
            }"
            mat-cell
            *matCellDef="let element"
          >
            <mat-checkbox
              disabled="true"
              [checked]="element.isReady"
            ></mat-checkbox>
          </td>
        </ng-container>
        <tr mat-header-row *matHeaderRowDef="displayedPlayerColumns"></tr>
        <tr
          mat-row
          *matRowDef="let row; columns: displayedPlayerColumns"
          (dblclick)="onDoubleClickPlayer(row)"
          (click)="choosePlayer(row)"
        ></tr>
      </table>
      <div class="p-2 text-right">
        <button
          *ngIf="chosenPlayer.name != undefined"
          mat-icon-button
          (click)="editPlayer()"
        >
          <mat-icon>edit</mat-icon>
        </button>
      </div>
    </div>
  </div>
</div>
